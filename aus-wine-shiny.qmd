---
title: "Australian Wine Shiny App"
format: html
---

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(fpp3)
library(gt)
library(tidyverse)
```

## Tab 1 - Visualization

### Data import / preparation

Inputs:
* Multiselect for Varietal
* Date range
    * First date is the train date cutoff (default to 1 year prior to the max date)
    * Second date is the end of the forecast horizon (default to last date)

```{r}
aus_wine <- read_csv(here::here("AustralianWines.csv"), na = "*",
                     col_types = cols(Rose = col_number()),
                     show_col_types = FALSE) |> 
    fill(Rose, .direction = "down") |> 
    mutate(Month = mdy(str_replace(Month, '-', '-01-')) |> yearmonth())

aus_wine_ts <- aus_wine |> 
    pivot_longer(cols = -Month, names_to = "Varietal", values_to = "Sales") |>
    as_tsibble(index = Month, key = Varietal)

# Create training cutoff
train_cutoff <- yearmonth("1994 Jan 01")
```

### Data visualization

```{r}
aus_wine_ts |> 
    autoplot(Sales) +
    labs(title = "Australian Wine Sales",
         y = "Sales"
         ) +
    geom_vline(xintercept = as_date(train_cutoff), color = "red", linetype = "dashed") +
    facet_wrap(~ Varietal, ncol = 1, scales = "free_y") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))

aus_wine_trn <- aus_wine_ts |>
    filter(Month < train_cutoff)
```

## Tab 2 - Model Building

### Model fitting

Inputs:
* Toggle for model specification (default off)
* Toggle Training accuracy (default off)

```{r}
fit <- aus_wine_trn |>
    model(
        tslm = TSLM(Sales ~ trend() + season()),
        ets = ETS(Sales),
        arima = ARIMA(Sales)
    )
```

### Training accuracy

```{r}
fit |>
    accuracy() |>
    select(Varietal, .model, RMSE, MAE, MAPE) |>
    arrange(.model, RMSE) |>
    gt() |> fmt_number(decimals = 2)

# Model specification for toggling
fit
```

## Tab 3 - Forecast

Inputs:
* Select the model for the Forecast table

### Forecast accuracy

```{r}
fc <- fit |>
    forecast(h = "12 months")

fc |>
    accuracy(aus_wine_ts) |>
    select(Varietal, .model, RMSE, MAE, MAPE) |>
    arrange(.model, RMSE) |>
    gt() |> fmt_number(decimals = 2)
```

### Forecast visualization

```{r}
fc |>
    autoplot(aus_wine_trn) +
    labs(title = "Australian Wine Sales Forecasts",
         y = "Sales",
         x = "Year"
         ) +
    facet_wrap(~ Varietal, scales = "free_y") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
```